name: Deploy Infrastructure

on:
  push:
    branches: [main]
    paths:
      - 'docker/**'
      - 'nginx/**'
      - 'loki/**'
      - 'promtail/**'
      - 'prometheus/**'
      - 'grafana/**'
      - 'scripts/**'
  pull_request:
    branches: [main]
    paths:
      - 'docker/**'
      - 'nginx/**'
      - 'loki/**'
      - 'promtail/**'
      - 'prometheus/**'
      - 'grafana/**'
      - 'scripts/**'

jobs:
  deploy-testing:
    if: github.event_name == 'pull_request'
    uses: iu-alumni/iu-alumni-infra/.github/workflows/deploy-service.yml@main
    with:
      repo_dir: infra
      branch: main
      environment: testing
    secrets:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}

  deploy-production:
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    uses: iu-alumni/iu-alumni-infra/.github/workflows/deploy-service.yml@main
    with:
      repo_dir: infra
      branch: main
      environment: production
    secrets:
      SERVER_HOST: ${{ secrets.SERVER_HOST }}
      SERVER_USER: ${{ secrets.SERVER_USER }}
      SERVER_SSH_KEY: ${{ secrets.SERVER_SSH_KEY }}
