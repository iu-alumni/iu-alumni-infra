name: Setup Server

on:
  workflow_dispatch:
    inputs:
      target:
        description: 'Target environment'
        required: true
        type: choice
        options:
          - testing
          - production
          - all
      ghcr_user:
        description: 'GitHub username for GHCR login (optional)'
        required: false
        type: string

jobs:
  setup:
    runs-on: ubuntu-latest
    environment: ${{ inputs.target == 'all' && 'production' || inputs.target }}
    steps:
      - uses: actions/checkout@v4

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Write SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SERVER_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.TEST_SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true
          ssh-keyscan -H ${{ secrets.PROD_SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || true

      - name: Run setup playbook
        working-directory: ansible
        run: |
          LIMIT_FLAG=""
          if [ "${{ inputs.target }}" != "all" ]; then
            LIMIT_FLAG="--limit ${{ inputs.target }}"
          fi

          GHCR_ARGS=""
          if [ -n "${{ inputs.ghcr_user }}" ]; then
            GHCR_ARGS="-e ghcr_user=${{ inputs.ghcr_user }} -e ghcr_token=${{ secrets.GHCR_TOKEN }}"
          fi

          ansible-playbook playbooks/setup-server.yml \
            $LIMIT_FLAG \
            -e "test_server_ip=${{ secrets.TEST_SERVER_HOST }}" \
            -e "prod_server_ip=${{ secrets.PROD_SERVER_HOST }}" \
            -e "server_user=${{ secrets.SERVER_USER }}" \
            $GHCR_ARGS \
            --private-key ~/.ssh/deploy_key
