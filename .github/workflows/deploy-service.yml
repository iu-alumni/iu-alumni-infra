name: Deploy Service

on:
  workflow_call:
    inputs:
      repo_dir:
        description: "Directory name on server under /home/deploy/iu-alumni/ (e.g. iu-alumni-backend, infra)"
        required: true
        type: string
      branch:
        description: "Branch to deploy (develop or main)"
        required: true
        type: string
      environment:
        description: "Deployment environment (testing or production)"
        required: true
        type: string
      image_tag:
        description: "Docker image tag passed as IMAGE_TAG env var (optional)"
        required: false
        type: string
        default: ""
    secrets:
      SERVER_HOST:
        required: true
      SERVER_USER:
        required: true
      SERVER_SSH_KEY:
        required: true

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment }}
    steps:
      - name: Deploy via SSH
        uses: appleboy/ssh-action@v1
        with:
          host: ${{ secrets.SERVER_HOST }}
          username: ${{ secrets.SERVER_USER }}
          key: ${{ secrets.SERVER_SSH_KEY }}
          script: |
            set -e
            DEPLOY_DIR="${DEPLOY_DIR:-/home/deploy/iu-alumni}"
            REPO_DIR="$DEPLOY_DIR/${{ inputs.repo_dir }}"
            REPO_URL="${{ github.server_url }}/${{ github.repository }}.git"

            # Load env vars (may override DEPLOY_DIR)
            if [ -f "$DEPLOY_DIR/.env" ]; then set -a && . "$DEPLOY_DIR/.env" && set +a; fi

            if [ -d "$REPO_DIR/.git" ]; then
              cd "$REPO_DIR" && git fetch origin && git reset --hard origin/${{ inputs.branch }}
            else
              mkdir -p "$DEPLOY_DIR"
              git clone -b ${{ inputs.branch }} "$REPO_URL" "$REPO_DIR"
            fi

            cd "$DEPLOY_DIR" && chmod +x "$REPO_DIR/scripts/deploy.sh"
            IMAGE_TAG="${{ inputs.image_tag }}" DEPLOY_DIR="$DEPLOY_DIR" "$REPO_DIR/scripts/deploy.sh" deploy
