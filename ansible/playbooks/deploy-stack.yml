---
# Deploy the Docker stack to a server.
# Usage:
#   ansible-playbook playbooks/deploy-stack.yml --limit testing -e "test_server_ip=X.X.X.X server_user=deploy"
#   ansible-playbook playbooks/deploy-stack.yml --limit production -e "prod_server_ip=X.X.X.X server_user=deploy"

- name: Deploy IU Alumni Stack
  hosts: all
  become: true

  vars:
    deploy_dir: /home/deploy/iu-alumni

  tasks:
    - name: Ensure deploy directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - "{{ deploy_dir }}"
        - "{{ deploy_dir }}/nginx/conf.d"
        - "{{ deploy_dir }}/nginx/certbot/conf"
        - "{{ deploy_dir }}/nginx/certbot/www"
        - "{{ deploy_dir }}/data/postgres"
        - "{{ deploy_dir }}/data/minio"
        - "{{ deploy_dir }}/loki"
        - "{{ deploy_dir }}/promtail"

    - name: Sync stack configuration files
      become: true
      become_user: "{{ ansible_user }}"
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../../docker/"
        dest: "{{ deploy_dir }}/docker/"
        delete: true

    - name: Sync nginx configs
      become: true
      become_user: "{{ ansible_user }}"
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../../nginx/"
        dest: "{{ deploy_dir }}/nginx/"
        delete: false

    - name: Sync Loki config
      become: true
      become_user: "{{ ansible_user }}"
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../../loki/"
        dest: "{{ deploy_dir }}/loki/"

    - name: Sync Promtail config
      become: true
      become_user: "{{ ansible_user }}"
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../../promtail/"
        dest: "{{ deploy_dir }}/promtail/"

    - name: Sync deploy scripts
      become: true
      become_user: "{{ ansible_user }}"
      ansible.posix.synchronize:
        src: "{{ playbook_dir }}/../../scripts/"
        dest: "{{ deploy_dir }}/scripts/"

    - name: Make scripts executable
      ansible.builtin.file:
        path: "{{ deploy_dir }}/scripts/deploy.sh"
        mode: "0755"

    - name: Make init-databases executable
      ansible.builtin.file:
        path: "{{ deploy_dir }}/docker/init-databases.sh"
        mode: "0755"

    - name: Copy nginx config template
      ansible.builtin.copy:
        src: "{{ deploy_dir }}/nginx/app.conf.template"
        dest: "{{ deploy_dir }}/nginx/conf.d/app.conf"
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"

    - name: Set domain in nginx config
      ansible.builtin.replace:
        path: "{{ deploy_dir }}/nginx/conf.d/app.conf"
        regexp: '\$\{DOMAIN\}'
        replace: "{{ domain }}"

    - name: Deploy Docker stack
      become: true
      become_user: "{{ ansible_user }}"
      ansible.builtin.shell:
        cmd: |
          cd {{ deploy_dir }} && docker stack deploy -c docker/stack.yml iu_alumni
        executable: /bin/bash
      environment:
        PATH: "/usr/local/bin:/usr/bin:/bin"
      changed_when: true
