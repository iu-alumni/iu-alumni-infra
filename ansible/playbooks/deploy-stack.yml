---
# Deploy the Docker stack to a server.
# Usage:
#   ansible-playbook playbooks/deploy-stack.yml --limit testing -e "test_server_ip=X.X.X.X server_user=deploy"
#   ansible-playbook playbooks/deploy-stack.yml --limit production -e "prod_server_ip=X.X.X.X server_user=deploy"

- name: Deploy IU Alumni Stack
  hosts: all
  become: true

  vars:
    repo_url: "{{ infra_repo_url | default('https://github.com/iu-alumni/iu-alumni-infra.git') }}"
    repo_branch: "{{ 'develop' if 'testing' in group_names else 'main' }}"

  tasks:
    - name: Ensure deploy directory exists
      ansible.builtin.file:
        path: "{{ deploy_dir }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"

    - name: Clone or update infra repo
      become_user: "{{ ansible_user }}"
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ deploy_dir }}/infra"
        version: "{{ repo_branch }}"
        force: true
      register: git_result

    - name: Ensure data directories exist
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0755"
      loop:
        - "{{ deploy_dir }}/nginx/conf.d"
        - "{{ deploy_dir }}/nginx/certbot/conf"
        - "{{ deploy_dir }}/nginx/certbot/www"
        - "{{ deploy_dir }}/data/postgres"
        - "{{ deploy_dir }}/data/minio"

    - name: Make scripts executable
      ansible.builtin.file:
        path: "{{ item }}"
        mode: "0755"
      loop:
        - "{{ deploy_dir }}/infra/scripts/deploy.sh"
        - "{{ deploy_dir }}/infra/docker/init-databases.sh"

    - name: Check if SSL certs exist
      ansible.builtin.stat:
        path: "{{ deploy_dir }}/nginx/certbot/conf/live/{{ domain }}/fullchain.pem"
      register: ssl_cert

    - name: Generate nginx config from template (SSL)
      ansible.builtin.copy:
        src: "{{ deploy_dir }}/infra/nginx/app.conf.template"
        dest: "{{ deploy_dir }}/nginx/conf.d/app.conf"
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"
      when: ssl_cert.stat.exists

    - name: Generate nginx config from template (no SSL)
      ansible.builtin.copy:
        src: "{{ deploy_dir }}/infra/nginx/app-init.conf.template"
        dest: "{{ deploy_dir }}/nginx/conf.d/app.conf"
        remote_src: true
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"
      when: not ssl_cert.stat.exists

    - name: Set domain in nginx config
      ansible.builtin.replace:
        path: "{{ deploy_dir }}/nginx/conf.d/app.conf"
        regexp: '\$\{DOMAIN\}'
        replace: "{{ domain }}"

    - name: Deploy Docker stack
      become: true
      become_user: "{{ ansible_user }}"
      ansible.builtin.command:
        cmd: "{{ deploy_dir }}/scripts/deploy.sh deploy"
      environment:
        PATH: "/usr/local/bin:/usr/bin:/bin"
      changed_when: true
